<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Boston Celtics</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="images/backgrounds/celticsweb.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 120px auto 60px; /* Adjusted margin for fixed navbar */
            padding: 2rem;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(186, 150, 83, 0.2);
            color: #fff;
            position: relative;
            z-index: 10;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--celtics-gold);
            padding-bottom: 1rem;
        }

        .admin-title {
            color: var(--celtics-gold);
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }

        .refresh-btn {
            background-color: var(--celtics-gold);
            color: var(--black);
            padding: 0.7rem 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background-color: #d4a74a;
            transform: translateY(-2px);
        }

        .refresh-btn::before {
            content: "↻";
            font-size: 1.2rem;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .users-table th,
        .users-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .users-table th {
            background-color: rgba(186, 150, 83, 0.2);
            font-weight: 600;
            color: var(--celtics-gold);
            position: relative;
            text-align: left;
            padding: 1rem;
        }

        .users-table tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .users-table tr:hover {
            background-color: rgba(186, 150, 83, 0.1);
        }

        .action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .edit-btn {
            background-color: var(--celtics-green);
            color: white;
        }

        .edit-btn:hover {
            background-color: #008f3e;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background-color: #b02a37;
        }

        .user-count {
            background-color: rgba(186, 150, 83, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            font-weight: 600;
            color: var(--celtics-gold);
            display: inline-block;
        }
        
        .edit-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close-modal-btn {
            position: absolute;
            right: 15px;
            top: 15px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            transition: color 0.2s;
        }

        .close-modal-btn:hover {
            color: #ff4444;
        }

        .modal-title {
            margin: 0 0 25px 0;
            color: #333;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-title i {
            color: #4a90e2;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group label i {
            color: #4a90e2;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus {
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
            outline: none;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }

        .form-actions button {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .cancel-btn {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            color: #666;
        }

        .cancel-btn:hover {
            background-color: #eee;
        }

        .save-btn {
            background-color: #4a90e2;
            border: none;
            color: white;
        }

        .save-btn:hover {
            background-color: #357abd;
        }

        .save-btn:disabled,
        .cancel-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .loading-spinner {
            text-align: center;
            padding: 30px;
            color: #4a90e2;
            font-size: 24px;
        }

        /* Toast styling */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            z-index: 1001;
            animation: toastSlideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            background-color: #4caf50;
        }

        .toast.error {
            background-color: #f44336;
        }

        .toast.warning {
            background-color: #ff9800;
        }

        .toast.info {
            background-color: #2196f3;
        }

        .error-message {
            color: #dc3545;
            margin-top: 1rem;
            text-align: center;
            padding: 0.5rem;
            background-color: rgba(220, 53, 69, 0.1);
            border-radius: 5px;
            display: none;
        }

        .success-message {
            color: #28a745;
            margin-top: 1rem;
            text-align: center;
            padding: 0.5rem;
            background-color: rgba(40, 167, 69, 0.1);
            border-radius: 5px;
            display: none;
        }

        .no-data {
            text-align: center;
            padding: 2rem;
            color: var(--celtics-gold);
            font-style: italic;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            border: 1px solid rgba(186, 150, 83, 0.1);
        }

        .user-email {
            color: #ccc;
            font-size: 0.9rem;
        }

        /* Ticket management styles */
        .ticket-btn {
            background-color: var(--celtics-gold);
            color: var(--black);
        }

        .ticket-btn:hover {
            background-color: #d4a74a;
        }

        .tickets-container {
            display: none;
            background: rgba(15, 15, 15, 0.8);
            border-radius: 12px;
            margin: 10px 0;
            padding: 20px;
            border: 1px solid rgba(186, 150, 83, 0.15);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .tickets-header {
            color: var(--celtics-gold);
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(186, 150, 83, 0.2);
        }

        .tickets-header h3 {
            margin: 0;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tickets-header h3::before {
            content: '\f145';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 1.2rem;
            color: var(--celtics-gold);
        }

        .tickets-close {
            cursor: pointer;
            color: var(--celtics-gold);
            font-size: 1.2rem;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(186, 150, 83, 0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(186, 150, 83, 0.2);
        }

        .tickets-close:hover {
            background: rgba(186, 150, 83, 0.2);
            transform: rotate(90deg);
            border-color: rgba(186, 150, 83, 0.3);
        }

        /* Ticket filtering controls */
        .tickets-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(186, 150, 83, 0.1);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .tickets-summary {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
        }
        
        .tickets-count {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-weight: 500;
        }
        
        .tickets-count-label {
            color: var(--celtics-gold);
            margin-right: 5px;
        }
        
        /* Prevent duplicate count displays */
        .tickets-count:not(:first-child) {
            display: none;
        }
        
        .tickets-filters {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-item {
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #ccc;
            font-weight: 500;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .filter-item:hover {
            background: rgba(186, 150, 83, 0.1);
            border-color: rgba(186, 150, 83, 0.2);
            color: var(--celtics-gold);
        }
        
        .filter-item.active {
            background: rgba(186, 150, 83, 0.2);
            border-color: rgba(186, 150, 83, 0.3);
            color: var(--celtics-gold);
        }
        
        .filter-item .fa-circle {
            font-size: 8px;
        }
        
        .filter-pending .fa-circle {
            color: #ffc107;
        }
        
        .filter-approved .fa-circle {
            color: #28a745;
        }
        
        .filter-rejected .fa-circle {
            color: #dc3545;
        }
        
        .filter-all .fa-circle {
            color: var(--celtics-gold);
        }
        
        @media (max-width: 768px) {
            .tickets-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .tickets-filters {
                margin-top: 10px;
                flex-wrap: wrap;
            }
        }

        .tickets-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ticket-item {
            background: rgba(22, 22, 22, 0.95);
            border-left: 4px solid;
            border-radius: 4px;
            overflow: hidden;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 20px;
            margin-bottom: 2px;
        }

        .ticket-item[data-status="pending"] {
            border-left-color: #ffc107;
        }

        .ticket-item[data-status="approved"] {
            border-left-color: #28a745;
        }

        .ticket-item[data-status="rejected"] {
            border-left-color: #dc3545;
        }

        .ticket-game {
            font-weight: 600;
            font-size: 1rem;
            color: #fff;
            min-width: 200px;
            flex: 0 0 auto;
        }

        .ticket-details {
            display: flex;
            align-items: center;
            gap: 24px;
            flex: 1;
            padding: 0;
            flex-wrap: wrap;
        }

        .ticket-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
            min-width: 120px;
        }

        .ticket-info-label {
            color: var(--celtics-gold);
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ticket-info-value {
            color: #fff;
            font-size: 0.9rem;
        }

        .ticket-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            min-width: 100px;
            justify-content: center;
        }

        .ticket-status-pending {
            background-color: rgba(255, 193, 7, 0.15);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .ticket-status-approved {
            background-color: rgba(40, 167, 69, 0.15);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .ticket-status-rejected {
            background-color: rgba(220, 53, 69, 0.15);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .ticket-status .fa-circle {
            font-size: 6px;
        }

        .ticket-actions {
            display: flex;
            gap: 8px;
            padding: 0;
            background: none;
            border: none;
            margin-left: auto;
            flex: 0 0 auto;
        }

        .ticket-actions .action-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
        }

        .ticket-actions .edit-btn {
            color: var(--celtics-gold);
        }

        .ticket-actions .edit-btn:hover {
            background: rgba(186, 150, 83, 0.2);
            transform: rotate(15deg);
        }

        .ticket-actions .delete-btn {
            color: #dc3545;
        }

        .ticket-actions .delete-btn:hover {
            background: rgba(220, 53, 69, 0.2);
            transform: scale(1.1);
        }

        .ticket-edit-form {
            background: rgba(30, 30, 30, 0.95);
            padding: 20px;
            border-radius: 8px;
            margin: 2px 0 10px;
            border: 1px solid rgba(186, 150, 83, 0.2);
        }

        .ticket-edit-form .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .ticket-edit-form .form-group {
            margin: 0;
        }

        .ticket-edit-form .form-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: var(--celtics-gold);
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ticket-edit-form .form-group input,
        .ticket-edit-form .form-group select,
        .ticket-edit-form .form-group textarea {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(186, 150, 83, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .ticket-edit-form .form-group input:focus,
        .ticket-edit-form .form-group select:focus,
        .ticket-edit-form .form-group textarea:focus {
            border-color: var(--celtics-gold);
            outline: none;
            background: rgba(255, 255, 255, 0.08);
        }

        .ticket-edit-form .form-group.ticket-form-full {
            grid-column: 1 / -1;
        }

        .ticket-edit-form .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .ticket-edit-form .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ticket-edit-form .form-actions button {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .ticket-edit-form .form-actions .save-btn {
            background-color: var(--celtics-green);
            color: white;
            border: none;
        }

        .ticket-edit-form .form-actions .save-btn:hover {
            background-color: #008f49;
        }

        .ticket-edit-form .form-actions .cancel-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ticket-edit-form .form-actions .cancel-btn:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .ticket-edit-form .form-actions button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .ticket-item {
                flex-wrap: wrap;
            }
            
            .ticket-game {
                flex: 1 1 100%;
                min-width: 0;
            }
            
            .ticket-details {
                flex: 1 1 calc(100% - 150px);
            }
            
            .ticket-actions {
                flex: 0 0 auto;
            }
        }

        @media (max-width: 768px) {
            .ticket-details {
                flex: 1 1 100%;
                margin: 10px 0;
                gap: 16px;
            }
            
            .ticket-info {
                min-width: calc(50% - 8px);
            }
            
            .ticket-actions {
                flex: 1 1 100%;
                justify-content: flex-end;
            }
            
            .ticket-edit-form .form-grid {
                grid-template-columns: 1fr;
            }
        }

        .no-tickets {
            color: #aaa;
            font-style: italic;
            text-align: center;
            padding: 40px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px dashed rgba(255, 255, 255, 0.1);
            grid-column: 1 / -1;
        }

        .loading-tickets {
            color: var(--celtics-gold);
            text-align: center;
            padding: 30px;
            grid-column: 1 / -1;
        }

        /* Media queries for responsiveness */
        @media (max-width: 768px) {
            .tickets-list {
                grid-template-columns: 1fr;
            }

            .ticket-details {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .ticket-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .ticket-game {
                max-width: 100%;
                margin-bottom: 5px;
            }
        }

        /* Ticket edit modal */
        .edit-ticket-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px 0;
        }

        .ticket-modal-content {
            background-color: #111;
            color: #fff;
            width: 90%;
            max-width: 800px;
            margin: 5vh auto;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(186, 150, 83, 0.3);
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
        }

        .ticket-modal-header {
            border-bottom: 2px solid var(--celtics-gold);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ticket-modal-title {
            color: var(--celtics-gold);
            font-size: 1.6rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .close-ticket-modal {
            background: rgba(186, 150, 83, 0.1);
            border: none;
            color: var(--celtics-gold);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .close-ticket-modal:hover {
            background: rgba(186, 150, 83, 0.2);
            transform: rotate(90deg);
        }

        .ticket-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .ticket-form-full {
            grid-column: 1 / -1;
        }

        .ticket-form-section {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ticket-form-section label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--celtics-gold);
            font-size: 0.9rem;
        }

        .ticket-form-section input,
        .ticket-form-section select,
        .ticket-form-section textarea {
            width: 100%;
            padding: 0.7rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(186, 150, 83, 0.2);
            border-radius: 5px;
            color: #fff;
            font-size: 1rem;
            transition: border-color 0.2s, background-color 0.2s;
        }

        .ticket-form-section input:focus,
        .ticket-form-section select:focus,
        .ticket-form-section textarea:focus {
            border-color: var(--celtics-gold);
            outline: none;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 2px rgba(186, 150, 83, 0.2);
        }

        .ticket-form-section input:hover,
        .ticket-form-section select:hover,
        .ticket-form-section textarea:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(186, 150, 83, 0.3);
        }

        .ticket-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ticket-save-btn, .ticket-cancel-btn {
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .ticket-save-btn {
            background-color: var(--celtics-green);
            color: white;
            border: none;
        }

        .ticket-save-btn:hover {
            background-color: #008f49;
            transform: translateY(-2px);
        }

        .ticket-cancel-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: #ddd;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ticket-cancel-btn:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .status-select-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .status-select {
            width: 100%;
            padding: 0.7rem;
            padding-left: 2.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(186, 150, 83, 0.2);
            border-radius: 5px;
            color: #fff;
            font-size: 1rem;
            appearance: none;
            -webkit-appearance: none;
        }

        .status-indicator {
            position: absolute;
            top: 50%;
            left: 0.8rem;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-pending {
            background-color: #ffc107;
        }

        .status-approved {
            background-color: #28a745;
        }

        .status-rejected {
            background-color: #dc3545;
        }

        .ticket-price-summary {
            background: rgba(186, 150, 83, 0.05);
            border: 1px solid rgba(186, 150, 83, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .price-row.price-total {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600;
            color: var(--celtics-gold);
            font-size: 1rem;
        }

        @media (min-width: 768px) {
            .ticket-form-grid .ticket-form-section:nth-child(1),  /* Game */
            .ticket-form-grid .ticket-form-section:nth-child(2) { /* Section Type */
                grid-column: span 1;
            }
            
            .ticket-form-grid .ticket-form-section:nth-child(3),  /* Section */
            .ticket-form-grid .ticket-form-section:nth-child(4) { /* Quantity */
                grid-column: span 1;
            }
            
            .ticket-form-grid .ticket-form-section:nth-child(5),  /* Price Range */
            .ticket-form-grid .ticket-form-section:nth-child(6),  /* Base Price */
            .ticket-form-grid .ticket-form-section:nth-child(7) { /* Total Price */
                grid-column: span 1;
            }
            
            .ticket-form-grid .ticket-form-section:nth-child(8) { /* Status */
                grid-column: 1;
            }
            
            .ticket-form-grid .ticket-form-section:nth-child(9) { /* Notes */
                grid-column: span 2;
            }
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Add styles for close-modal-btn */
        .close-modal-btn {
            background: rgba(186, 150, 83, 0.1);
            border: none;
            color: var(--celtics-gold);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .close-modal-btn:hover {
            background: rgba(186, 150, 83, 0.2);
            transform: rotate(90deg);
        }

        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
            transition: border-color 0.2s, box-shadow 0.2s;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 35px;
        }

        .form-group select:focus {
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
            outline: none;
        }

        .form-group input[type="date"] {
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3e%3c/rect%3e%3cline x1='16' y1='2' x2='16' y2='6'%3e%3c/line%3e%3cline x1='8' y1='2' x2='8' y2='6'%3e%3c/line%3e%3cline x1='3' y1='10' x2='21' y2='10'%3e%3c/line%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 35px;
        }

        .form-group input[type="number"] {
            appearance: textfield;
            -webkit-appearance: textfield;
        }

        .form-group input[type="number"]::-webkit-outer-spin-button,
        .form-group input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Add custom number controls */
        .form-group.number-input {
            position: relative;
        }

        .form-group.number-input::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cline x1='12' y1='5' x2='12' y2='19'%3e%3c/line%3e%3cline x1='5' y1='12' x2='19' y2='12'%3e%3c/line%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            pointer-events: none;
        }

        .edit-form-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .edit-row td {
            padding: 0;
        }
        
        .action-btn.active {
            background-color: #dc3545;
        }
        
        .action-btn.active:hover {
            background-color: #c82333;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .form-actions button {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .form-actions .save-btn {
            background-color: #28a745;
            color: white;
            border: none;
        }
        
        .form-actions .save-btn:hover {
            background-color: #218838;
        }
        
        .form-actions .cancel-btn {
            background-color: #6c757d;
            color: white;
            border: none;
        }
        
        .form-actions .cancel-btn:hover {
            background-color: #5a6268;
        }
        
        .form-actions button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .ticket-edit-form {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid rgba(186, 150, 83, 0.2);
        }
        
        .ticket-edit-form .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .ticket-edit-form .ticket-form-full {
            grid-column: 1 / -1;
        }
        
        .ticket-edit-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(186, 150, 83, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
        }
        
        .ticket-edit-form textarea:focus {
            border-color: var(--celtics-gold);
            outline: none;
            background: rgba(255, 255, 255, 0.08);
        }
        
        .ticket-edit-form .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .ticket-edit-form .form-actions button {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .ticket-edit-form .form-actions .save-btn {
            background-color: #28a745;
            color: white;
            border: none;
        }
        
        .ticket-edit-form .form-actions .save-btn:hover {
            background-color: #218838;
        }
        
        .ticket-edit-form .form-actions .cancel-btn {
            background-color: #6c757d;
            color: white;
            border: none;
        }
        
        .ticket-edit-form .form-actions .cancel-btn:hover {
            background-color: #5a6268;
        }
        
        .ticket-edit-form .form-actions button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        // Function to show notification messages
        function showNotification(message, type = 'info') {
            // Create notification container if it doesn't exist
            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.style.position = 'fixed';
                container.style.top = '80px';
                container.style.right = '20px';
                container.style.zIndex = '1000';
                document.body.appendChild(container);
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.padding = '12px 20px';
            notification.style.margin = '10px 0';
            notification.style.borderRadius = '5px';
            notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            notification.style.display = 'flex';
            notification.style.alignItems = 'center';
            notification.style.animation = 'notification-slide-in 0.3s ease-out forwards';
            
            // Set colors based on type
            if (type === 'success') {
                notification.style.backgroundColor = 'rgba(40, 167, 69, 0.9)';
                notification.style.color = 'white';
            } else if (type === 'error') {
                notification.style.backgroundColor = 'rgba(220, 53, 69, 0.9)';
                notification.style.color = 'white';
            } else {
                notification.style.backgroundColor = 'rgba(23, 162, 184, 0.9)';
                notification.style.color = 'white';
            }
            
            // Add icon based on type
            let icon;
            if (type === 'success') {
                icon = 'check-circle';
            } else if (type === 'error') {
                icon = 'exclamation-circle';
            } else {
                icon = 'info-circle';
            }
            
            notification.innerHTML = `
                <i class="fas fa-${icon}" style="margin-right: 10px;"></i>
                <span>${message}</span>
            `;
            
            // Add to container
            container.appendChild(notification);
            
            // Remove after timeout
            setTimeout(() => {
                notification.style.animation = 'notification-slide-out 0.3s ease-in forwards';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Add notification animations to the document
            const styleElement = document.createElement('style');
            styleElement.textContent = `
                @keyframes notification-slide-in {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                
                @keyframes notification-slide-out {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(styleElement);
        });

        // Add styles for editing state
        .ticket-item.editing {
            border-color: var(--celtics-green);
            box-shadow: 0 0 10px rgba(0, 146, 70, 0.3);
        }

        .ticket-edit-form {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .form-actions {
            margin-top: 15px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .price-info {
            margin: 15px 0;
            padding: 10px;
            background-color: rgba(186, 150, 83, 0.1);
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-left">
                <a href="MYweb.html">
                    <img src="images/backgrounds/logo2.svg" alt="Celtics Logo" class="logo-img">
                </a>
                <div class="nav-links">
                    <a href="MYweb.html#news" class="nav-link">News</a>
                    <a href="schedule.html" class="nav-link">Schedule</a>
                    <a href="roster.html" class="nav-link">Roster</a>
                    <a href="getTickets.html" class="nav-link">Get Tickets</a>
                </div>
            </div>
            <div class="nav-right">
                <a href="login.html" class="btn btn-outline">Login</a>
                <a href="register.html" class="btn btn-outline">Sign Up</a>
                <a href="MYweb.html#footer-contact" class="btn btn-outline">Contact</a>
            </div>
            <button class="mobile-menu-btn" aria-label="Toggle mobile menu">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-header">
            <h1 class="admin-title">Admin Dashboard</h1>
            <button class="refresh-btn" onclick="refreshUsers()">Refresh Users</button>
        </div>

        <div id="error-message" class="error-message"></div>
        <div id="success-message" class="success-message"></div>
        
        <div id="user-count" class="user-count">Loading users...</div>

        <table class="users-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Location</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="users-table-body">
                <!-- Users will be populated here -->
            </tbody>
        </table>
        <div id="no-data" class="no-data" style="display:none">No users found in the system.</div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-modal" class="edit-modal">
        <div class="modal-content">
            <button class="close-modal-btn" onclick="closeEditModal()">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="modal-title"><i class="fas fa-user-edit"></i> Edit User</h2>
            
            <form id="edit-user-form" onsubmit="handleUserEdit(event)">
                <input type="hidden" id="edit-user-id">
                
                <div class="form-group">
                    <label for="edit-first-name">
                        <i class="fas fa-user"></i> First Name
                    </label>
                    <input type="text" id="edit-first-name" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-last-name">
                        <i class="fas fa-user"></i> Last Name
                    </label>
                    <input type="text" id="edit-last-name" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-email">
                        <i class="fas fa-envelope"></i> Email
                    </label>
                    <input type="email" id="edit-email" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-phone">
                        <i class="fas fa-phone"></i> Phone
                    </label>
                    <input type="tel" id="edit-phone" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-location">
                        <i class="fas fa-map-marker-alt"></i> Location
                    </label>
                    <input type="text" id="edit-location" required>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cancel-btn" onclick="closeEditModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="save-btn">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ticket Edit Modal -->
    <div id="editTicketModal" class="edit-ticket-modal">
        <div class="ticket-modal-content">
            <div class="ticket-modal-header">
                <h2 class="ticket-modal-title"><i class="fas fa-ticket-alt"></i> Edit Ticket Request</h2>
                <button class="close-modal-btn" onclick="closeTicketModal()"><i class="fas fa-times"></i></button>
            </div>
            
            <form id="ticketEditForm" class="ticket-edit-form" onsubmit="event.preventDefault(); submitTicketForm();">
                <input type="hidden" id="ticketIdInput" name="_id">
                
                <div class="ticket-form-grid">
                    <div class="ticket-form-section">
                        <label for="game">Game</label>
                        <input type="text" id="game" name="game" required>
                    </div>
                    
                    <div class="ticket-form-section">
                        <label for="sectionType">Section Type</label>
                        <select id="sectionType" name="sectionType" required onchange="updateAdminSections()">
                            <option value="">Select section type</option>
                            <option value="Floor">Floor</option>
                            <option value="VIP">VIP</option>
                            <option value="Lower">Lower Level</option>
                            <option value="Mid">Mid Level</option>
                            <option value="Upper">Upper Level</option>
                            <option value="Special">Special Event</option>
                        </select>
                    </div>
                    
                    <div class="ticket-form-section">
                        <label for="section">Section</label>
                        <input type="text" id="section" name="section" required>
                    </div>
                    
                    <div class="ticket-form-section">
                        <label for="quantity">Quantity</label>
                        <input type="number" id="quantity" name="quantity" min="1" max="10" required>
                    </div>
                    
                    <div class="ticket-form-section">
                        <label for="basePrice">Base Price ($)</label>
                        <input type="number" id="basePrice" name="basePrice" min="0" step="0.01" required>
                    </div>
                    
                    <div class="ticket-form-section">
                        <label for="totalPrice">Total Price ($)</label>
                        <input type="number" id="totalPrice" name="totalPrice" min="0" step="0.01" required>
                    </div>
                    
                    <div class="ticket-form-section">
                        <label for="status">Status</label>
                        <select id="status" name="status" required>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    
                    <div class="ticket-form-section">
                        <label for="notes">Admin Notes</label>
                        <textarea id="notes" name="notes" rows="4"></textarea>
                    </div>
                </div>
                
                <div class="ticket-form-actions">
                    <button type="button" class="ticket-cancel-btn" onclick="closeTicketModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" id="ticketSaveBtn" class="ticket-save-btn">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ticket Edit Modal -->
    <div id="ticket-edit-modal" class="edit-modal">
        <div class="modal-content">
            <button class="close-modal-btn" onclick="closeTicketEditModal()">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="modal-title"><i class="fas fa-ticket-alt"></i> Edit Ticket</h2>
            
            <form id="ticket-edit-form">
                <!-- Form content will be dynamically populated -->
            </form>
        </div>
    </div>

    <script src="auth.js"></script>
    <script src="navbar.js"></script>
    <script>
        // Improved admin status check with local storage caching to prevent jumps
        let adminCheckInProgress = false;
        
        async function checkAdminStatus() {
            // Prevent multiple simultaneous checks
            if (adminCheckInProgress) return;
            adminCheckInProgress = true;
            
            try {
                // Try to use cached result first
                const cachedAdmin = localStorage.getItem('isAdmin');
                const cachedTime = localStorage.getItem('adminCheckTime');
                const now = Date.now();
                
                // Use cache if it's less than 5 minutes old
                if (cachedAdmin && cachedTime && (now - parseInt(cachedTime)) < 5 * 60 * 1000) {
                    if (cachedAdmin === 'false') {
                        console.log('Using cached admin status: Not admin');
                        showToast('Access Denied: Admin privileges required', 'error');
                        setTimeout(() => {
                            window.location.href = '/MYweb.html';
                        }, 1500);
                        return;
                    } else if (cachedAdmin === 'true') {
                        console.log('Using cached admin status: Is admin');
                        loadUsers();
                        return;
                    }
                }
                
                // If no valid cache, check with server
                const response = await fetch('/api/user/profile', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const status = response.status;
                    localStorage.removeItem('isAdmin');
                    
                    if (status === 401 || status === 403) {
                        showToast('Please log in to access admin panel', 'error');
                        setTimeout(() => {
                            window.location.href = '/login.html?redirect=admin.html';
                        }, 1500);
                    } else {
                        showToast(`Server error (${status}). Please try again later.`, 'error');
                        setTimeout(() => {
                            window.location.href = '/MYweb.html';
                        }, 1500);
                    }
                    return;
                }
                
                const data = await response.json();
                
                if (!data.isAuthenticated) {
                    localStorage.removeItem('isAdmin');
                    showToast('Please log in to access admin panel', 'error');
                    setTimeout(() => {
                        window.location.href = '/login.html?redirect=admin.html';
                    }, 1500);
                    return;
                }
                
                // Save to localStorage
                localStorage.setItem('isAdmin', data.isAdmin.toString());
                localStorage.setItem('adminCheckTime', now.toString());
                
                if (!data.isAdmin) {
                    showToast('Access Denied: Admin privileges required', 'error');
                    setTimeout(() => {
                        window.location.href = '/MYweb.html';
                    }, 1500);
                    return;
                }
                
                // User is admin, load users
                loadUsers();
            } catch (error) {
                console.error('Error checking admin status:', error);
                localStorage.removeItem('isAdmin');
                showToast('Connection error. Please try again.', 'error');
                setTimeout(() => {
                    window.location.href = '/login.html?redirect=admin.html';
                }, 1500);
            } finally {
                adminCheckInProgress = false;
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch users');
                }
                
                const users = await response.json();
                document.getElementById('user-count').textContent = `Total Users: ${users.length}`;
                displayUsers(users);
                
                // Show no data message if no users
                if (users.length === 0) {
                    document.getElementById('no-data').style.display = 'block';
                } else {
                    document.getElementById('no-data').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('user-count').textContent = 'Error loading users';
                document.getElementById('users-table-body').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: #dc3545;">
                            ${error.message || 'Failed to load users. Please try again.'}
                        </td>
                    </tr>
                `;
            }
        }

        // Display users in table
        function displayUsers(users) {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-user-id', user._id);
                
                // Format the name with special styling if admin
                const nameCell = `
                    <strong>${user.firstName} ${user.lastName}</strong>
                    ${user.isAdmin ? '<span style="color: var(--celtics-gold); margin-left:5px;">(Admin)</span>' : ''}
                `;
                
                tr.innerHTML = `
                    <td>${nameCell}</td>
                    <td>
                        <span class="user-email">${user.email}</span>
                    </td>
                    <td>${user.phone || 'Not provided'}</td>
                    <td>${user.location || 'Not provided'}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="toggleUserEdit('${user._id}')">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteUser('${user._id}')">Delete</button>
                        <button class="action-btn ticket-btn" onclick="toggleTickets('${user._id}')">Tickets</button>
                    </td>
                `;
                tbody.appendChild(tr);
                
                // Add a row for editing that will be hidden initially
                const editRow = document.createElement('tr');
                editRow.className = 'edit-row';
                editRow.id = `edit-row-${user._id}`;
                editRow.style.display = 'none';
                
                const editCell = document.createElement('td');
                editCell.colSpan = 5;
                editCell.innerHTML = `
                    <div class="edit-form-container">
                        <form id="edit-user-form-${user._id}" onsubmit="handleUserEdit(event, '${user._id}')">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="edit-first-name-${user._id}">
                                        <i class="fas fa-user"></i> First Name
                                    </label>
                                    <input type="text" id="edit-first-name-${user._id}" value="${user.firstName}" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="edit-last-name-${user._id}">
                                        <i class="fas fa-user"></i> Last Name
                                    </label>
                                    <input type="text" id="edit-last-name-${user._id}" value="${user.lastName}" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="edit-email-${user._id}">
                                        <i class="fas fa-envelope"></i> Email
                                    </label>
                                    <input type="email" id="edit-email-${user._id}" value="${user.email}" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="edit-phone-${user._id}">
                                        <i class="fas fa-phone"></i> Phone
                                    </label>
                                    <input type="tel" id="edit-phone-${user._id}" value="${user.phone || ''}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="edit-location-${user._id}">
                                        <i class="fas fa-map-marker-alt"></i> Location
                                    </label>
                                    <input type="text" id="edit-location-${user._id}" value="${user.location || ''}">
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="cancel-btn" onclick="toggleUserEdit('${user._id}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button type="submit" class="save-btn">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                editRow.appendChild(editCell);
                tbody.appendChild(editRow);
                
                // Add a row for tickets that will be hidden initially
                const ticketsRow = document.createElement('tr');
                ticketsRow.className = 'tickets-row';
                ticketsRow.id = `tickets-row-${user._id}`;
                ticketsRow.style.display = 'none';
                
                const ticketsCell = document.createElement('td');
                ticketsCell.colSpan = 5;
                ticketsCell.innerHTML = `
                    <div class="tickets-container" id="tickets-container-${user._id}">
                        <div class="tickets-header">
                            <h3>Ticket History for ${user.firstName} ${user.lastName}</h3>
                            <span class="tickets-close" onclick="toggleTickets('${user._id}')">&times;</span>
                        </div>
                        <div class="tickets-list" id="tickets-list-${user._id}">
                            <p class="loading-tickets">Loading tickets...</p>
                        </div>
                    </div>
                `;
                
                ticketsRow.appendChild(ticketsCell);
                tbody.appendChild(ticketsRow);
            });
        }

        // Function to toggle user edit mode
        function toggleUserEdit(userId) {
            const editRow = document.getElementById(`edit-row-${userId}`);
            const editButton = document.querySelector(`tr[data-user-id="${userId}"] .edit-btn`);
            
            if (editRow.style.display === 'none') {
                // Show edit form
                editRow.style.display = 'table-row';
                editButton.innerHTML = '<i class="fas fa-times"></i> Cancel';
                editButton.classList.add('active');
            } else {
                // Hide edit form
                editRow.style.display = 'none';
                editButton.innerHTML = 'Edit';
                editButton.classList.remove('active');
                
                // Reset form
                const form = document.getElementById(`edit-user-form-${userId}`);
                if (form) {
                    form.reset();
                }
            }
        }

        // Function to handle user edit
        async function handleUserEdit(event, userId) {
            event.preventDefault();
            
            const form = event.target;
            const saveButton = form.querySelector('.save-btn');
            const cancelButton = form.querySelector('.cancel-btn');
            
            // Disable buttons and show loading state
            saveButton.disabled = true;
            cancelButton.disabled = true;
            const originalButtonText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            // Set timeout
            const timeout = setTimeout(() => {
                saveButton.disabled = false;
                cancelButton.disabled = false;
                saveButton.innerHTML = originalButtonText;
                showToast('Request is taking longer than expected. Please try again.', 'warning');
            }, 10000);
            
            try {
                const userData = {
                    firstName: document.getElementById(`edit-first-name-${userId}`).value.trim(),
                    lastName: document.getElementById(`edit-last-name-${userId}`).value.trim(),
                    email: document.getElementById(`edit-email-${userId}`).value.trim(),
                    phone: document.getElementById(`edit-phone-${userId}`).value.trim(),
                    location: document.getElementById(`edit-location-${userId}`).value.trim()
                };
                
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(userData)
                });
                
                clearTimeout(timeout);
                
                if (!response.ok) {
                    throw new Error(`Failed to update user: ${response.status}`);
                }
                
                // Success handling
                showToast('User updated successfully!', 'success');
                toggleUserEdit(userId);
                
                // Refresh the users list after a short delay
                setTimeout(() => {
                    loadUsers();
                }, 300);
                
            } catch (error) {
                console.error('Error updating user:', error);
                showToast(error.message || 'Failed to update user', 'error');
            } finally {
                clearTimeout(timeout);
                saveButton.disabled = false;
                cancelButton.disabled = false;
                saveButton.innerHTML = originalButtonText;
            }
        }

        // Delete user
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }

            // Get the row with the user to show loading state
            const userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
            if (userRow) {
                // Store original content and replace with loading indicator
                userRow.dataset.originalHtml = userRow.innerHTML;
                const loadingHtml = `
                    <td colspan="5" style="text-align: center; padding: 1rem;">
                        <i class="fas fa-spinner fa-spin" style="color: var(--celtics-gold); margin-right: 10px;"></i>
                        Deleting user...
                    </td>
                `;
                userRow.innerHTML = loadingHtml;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`Failed to delete user: ${response.status}`);
                }

                loadUsers();
                showSuccess('User deleted successfully');
            } catch (error) {
                console.error('Error deleting user:', error);
                showError('Failed to delete user');
                
                // Restore the original row content if there was an error
                if (userRow && userRow.dataset.originalHtml) {
                    userRow.innerHTML = userRow.dataset.originalHtml;
                }
            }
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }

        // Update status indicator
        function updateStatusIndicator(status) {
            // Find or create the status select wrapper
            let statusSelect = document.getElementById('edit-ticket-status');
            let wrapper = statusSelect.parentElement;
            
            if (!wrapper.classList.contains('status-select-wrapper')) {
                // Create wrapper
                wrapper = document.createElement('div');
                wrapper.className = 'status-select-wrapper';
                statusSelect.parentNode.insertBefore(wrapper, statusSelect);
                wrapper.appendChild(statusSelect);
                
                // Create indicator
                const indicator = document.createElement('span');
                indicator.className = 'status-indicator';
                wrapper.insertBefore(indicator, statusSelect);
            }
            
            // Get the indicator element
            const indicator = wrapper.querySelector('.status-indicator');
            
            // Remove all status classes
            indicator.classList.remove('status-pending', 'status-approved', 'status-rejected');
            
            // Add appropriate class
            if (status === 'Pending') {
                indicator.classList.add('status-pending');
            } else if (status === 'Approved') {
                indicator.classList.add('status-approved');
            } else if (status === 'Rejected') {
                indicator.classList.add('status-rejected');
            }
        }

        // Toggle tickets section for a user
        function toggleTickets(userId) {
            const ticketsRow = document.getElementById(`tickets-row-${userId}`);
            const ticketsContainer = document.getElementById(`tickets-container-${userId}`);
            
            if (ticketsRow.style.display === 'none') {
                // Show tickets
                ticketsRow.style.display = 'table-row';
                ticketsContainer.style.display = 'block';
                fetchUserTickets(userId);
            } else {
                // Hide tickets
                ticketsRow.style.display = 'none';
                ticketsContainer.style.display = 'none';
            }
        }

        // Function to submit ticket form
        async function submitTicketForm() {
            // Get form data
            const ticketId = document.getElementById('ticketIdInput').value;
            const form = document.getElementById('ticketEditForm');
            const userId = form.getAttribute('data-user-id');
            
            if (!ticketId || !userId) {
                showToast('Missing ticket or user information', 'error');
                console.error('Missing data - ticketId:', ticketId, 'userId:', userId);
                return;
            }
            
            // Store userId before anything else happens
            localStorage.setItem('lastTicketUserId', userId);
            
            // Disable save button and show loading state
            const saveButton = document.getElementById('ticketSaveBtn');
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            // Set timeout to prevent UI from being stuck if request takes too long
            const timeout = setTimeout(() => {
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                showToast('Request is taking longer than expected. Please try again.', 'warning');
            }, 10000);
            
            // Prepare ticket data - get values directly from form fields
            const ticketData = {
                game: document.getElementById('game').value,
                sectionType: document.getElementById('sectionType').value,
                section: document.getElementById('section').value,
                quantity: document.getElementById('quantity').value,
                basePrice: document.getElementById('basePrice').value,
                totalPrice: document.getElementById('totalPrice').value,
                status: document.getElementById('status').value,
                adminNotes: document.getElementById('notes').value
            };
            
            console.log('Submitting ticket data:', { ticketId, userId, ticketData });
            
            try {
                // Create a fetch call that handles the response properly
                const response = await fetch(`/api/admin/tickets/${userId}/${ticketId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(ticketData)
                });
                
                clearTimeout(timeout);
                console.log('Ticket update status:', response.status);
                
                // Try to parse response
                let responseData;
                try {
                    const responseText = await response.text();
                    console.log('Raw response:', responseText);
                    
                    if (responseText) {
                        responseData = JSON.parse(responseText);
                    }
                } catch (e) {
                    console.log('Response is not valid JSON:', e);
                }
                
                if (!response.ok) {
                    throw new Error(
                        (responseData && responseData.message) || 
                        `Error ${response.status}: Failed to update ticket`
                    );
                }
                
                // Success
                showToast('Ticket updated successfully!', 'success');
                console.log('Ticket updated successfully');
                
                // Close modal first
                closeTicketModal();
                
                // Ensure we have the user ID for refreshing
                const storedUserId = localStorage.getItem('lastTicketUserId') || userId;
                
                // Refresh tickets after a short delay using the saved userId
                setTimeout(() => {
                    fetchUserTickets(storedUserId);
                }, 300);
            } catch (error) {
                console.error('Error updating ticket:', error);
                showToast(error.message || 'Failed to update ticket', 'error');
            } finally {
                clearTimeout(timeout);
                // Always reset UI state
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            }
        }
        
        // Function to fetch user tickets
        async function fetchUserTickets(userId) {
            const ticketsList = document.getElementById(`tickets-list-${userId}`);
            if (!ticketsList) return;
            
            // Show temporary loading message
            ticketsList.innerHTML = '<p class="loading-tickets"><i class="fas fa-spinner fa-spin"></i> Loading tickets...</p>';
            
            try {
                const response = await fetch(`/api/admin/tickets/${userId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch tickets: ${response.status}`);
                }
                
                const tickets = await response.json();
                
                // Display tickets
                if (tickets.length === 0) {
                    ticketsList.innerHTML = '<p class="no-tickets">No tickets found for this user.</p>';
                    return;
                }
                
                // Add filtering controls
                ticketsList.innerHTML = '';
                addTicketControls(userId, tickets);
                displayUserTickets(userId, tickets);
            } catch (error) {
                console.error('Error fetching tickets:', error);
                ticketsList.innerHTML = `<p class="no-tickets">Error loading tickets: ${error.message}. Please try again.</p>`;
            }
        }
        
        // Function to add ticket filtering controls
        function addTicketControls(userId, tickets) {
            const ticketsContainer = document.getElementById(`tickets-container-${userId}`);
            if (!ticketsContainer) return;
            
            // Count tickets by status
            const counts = {
                all: tickets.length,
                pending: tickets.filter(t => t.status.toLowerCase() === 'pending').length,
                approved: tickets.filter(t => t.status.toLowerCase() === 'approved').length,
                rejected: tickets.filter(t => t.status.toLowerCase() === 'rejected').length
            };
            
            // Create controls element
            const controls = document.createElement('div');
            controls.className = 'tickets-controls';
            controls.innerHTML = `
                <div class="tickets-summary">
                    <div class="tickets-count">
                        <span class="tickets-count-label">Total:</span>
                        <span>${counts.all}</span>
                    </div>
                </div>
                <div class="tickets-filters">
                    <div class="filter-item filter-all active" data-filter="all">
                        <i class="fas fa-circle"></i> All (${counts.all})
                    </div>
                    <div class="filter-item filter-pending" data-filter="pending">
                        <i class="fas fa-circle"></i> Pending (${counts.pending})
                    </div>
                    <div class="filter-item filter-approved" data-filter="approved">
                        <i class="fas fa-circle"></i> Approved (${counts.approved})
                    </div>
                    <div class="filter-item filter-rejected" data-filter="rejected">
                        <i class="fas fa-circle"></i> Rejected (${counts.rejected})
                    </div>
                </div>
            `;
            
            // Clear any existing controls first to prevent duplicates
            const existingControls = ticketsContainer.querySelector('.tickets-controls');
            if (existingControls) {
                existingControls.remove();
            }
            
            // Insert controls before tickets list
            const ticketsList = document.getElementById(`tickets-list-${userId}`);
            if (ticketsList) {
                ticketsList.parentNode.insertBefore(controls, ticketsList);
                
                // Add event listeners to filters
                controls.querySelectorAll('.filter-item').forEach(filter => {
                    filter.addEventListener('click', () => {
                        // Update active state
                        controls.querySelectorAll('.filter-item').forEach(f => f.classList.remove('active'));
                        filter.classList.add('active');
                        
                        // Apply filter
                        const filterValue = filter.dataset.filter;
                        filterTickets(userId, filterValue);
                    });
                });
            }
        }
        
        // Function to filter tickets
        function filterTickets(userId, filterValue) {
            const ticketsList = document.getElementById(`tickets-list-${userId}`);
            if (!ticketsList) return;
            
            const tickets = ticketsList.querySelectorAll('.ticket-item');
            
            tickets.forEach(ticket => {
                if (filterValue === 'all') {
                    ticket.style.display = 'flex';
                } else {
                    const status = ticket.dataset.status.toLowerCase();
                    ticket.style.display = status === filterValue ? 'flex' : 'none';
                }
            });
        }
        
        // Function to display user tickets
        function displayUserTickets(userId, tickets) {
            const ticketsList = document.getElementById(`tickets-list-${userId}`);
            if (!ticketsList) return;
            
            // Clear existing content
            ticketsList.innerHTML = '';
            
            // Add tickets
            tickets.forEach(ticket => {
                const status = ticket.status.toLowerCase();
                const statusClass = `ticket-status-${status}`;
                const statusText = status.charAt(0).toUpperCase() + status.slice(1);
                
                const ticketElem = document.createElement('div');
                ticketElem.className = 'ticket-item';
                ticketElem.dataset.status = status;
                ticketElem.dataset.ticketId = ticket._id;
                
                // Format date
                const date = new Date(ticket.timestamp);
                const formattedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                ticketElem.innerHTML = `
                    <div class="ticket-game">${ticket.game}</div>
                    <div class="ticket-details">
                        <div class="ticket-info">
                            <span class="ticket-info-label">Date:</span>
                            <span class="ticket-info-value">${formattedDate}</span>
                        </div>
                        <div class="ticket-info">
                            <span class="ticket-info-label">Section:</span>
                            <span class="ticket-info-value">${ticket.section}</span>
                        </div>
                        <div class="ticket-info">
                            <span class="ticket-info-label">Type:</span>
                            <span class="ticket-info-value">${ticket.sectionType || 'N/A'}</span>
                        </div>
                        <div class="ticket-info">
                            <span class="ticket-info-label">Qty:</span>
                            <span class="ticket-info-value">${ticket.quantity}</span>
                        </div>
                        <div class="ticket-info">
                            <span class="ticket-info-label">Price:</span>
                            <span class="ticket-info-value">$${parseFloat(ticket.totalPrice).toFixed(2)}</span>
                        </div>
                        <div class="ticket-status ${statusClass}">
                            <i class="fas fa-circle"></i>
                            ${statusText}
                        </div>
                    </div>
                    <div class="ticket-actions">
                        <button class="action-btn edit-btn" onclick="toggleTicketEdit('${ticket._id}', '${userId}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteTicket('${ticket._id}', '${userId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                ticketsList.appendChild(ticketElem);
                
                // Add edit form that will be hidden initially
                const editForm = document.createElement('div');
                editForm.className = 'ticket-edit-form';
                editForm.id = `ticket-edit-form-${ticket._id}`;
                editForm.style.display = 'none';
                
                editForm.innerHTML = `
                    <form onsubmit="handleTicketEdit(event, '${ticket._id}', '${userId}')">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="edit-game-${ticket._id}">
                                    <i class="fas fa-gamepad"></i> Game
                                </label>
                                <input type="text" id="edit-game-${ticket._id}" value="${ticket.game}" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-section-type-${ticket._id}">
                                    <i class="fas fa-ticket-alt"></i> Section Type
                                </label>
                                <select id="edit-section-type-${ticket._id}" required>
                                    <option value="Floor" ${ticket.sectionType === 'Floor' ? 'selected' : ''}>Floor</option>
                                    <option value="VIP" ${ticket.sectionType === 'VIP' ? 'selected' : ''}>VIP</option>
                                    <option value="Lower" ${ticket.sectionType === 'Lower' ? 'selected' : ''}>Lower Level</option>
                                    <option value="Mid" ${ticket.sectionType === 'Mid' ? 'selected' : ''}>Mid Level</option>
                                    <option value="Upper" ${ticket.sectionType === 'Upper' ? 'selected' : ''}>Upper Level</option>
                                    <option value="Special" ${ticket.sectionType === 'Special' ? 'selected' : ''}>Special Event</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-section-${ticket._id}">
                                    <i class="fas fa-map-marker-alt"></i> Section
                                </label>
                                <input type="text" id="edit-section-${ticket._id}" value="${ticket.section}" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-quantity-${ticket._id}">
                                    <i class="fas fa-hashtag"></i> Quantity
                                </label>
                                <input type="number" id="edit-quantity-${ticket._id}" value="${ticket.quantity}" min="1" max="10" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-base-price-${ticket._id}">
                                    <i class="fas fa-dollar-sign"></i> Base Price ($)
                                </label>
                                <input type="number" id="edit-base-price-${ticket._id}" value="${ticket.basePrice}" min="0" step="0.01" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-total-price-${ticket._id}">
                                    <i class="fas fa-dollar-sign"></i> Total Price ($)
                                </label>
                                <input type="number" id="edit-total-price-${ticket._id}" value="${ticket.totalPrice}" min="0" step="0.01" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-status-${ticket._id}">
                                    <i class="fas fa-info-circle"></i> Status
                                </label>
                                <select id="edit-status-${ticket._id}" required>
                                    <option value="pending" ${ticket.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="approved" ${ticket.status === 'approved' ? 'selected' : ''}>Approved</option>
                                    <option value="rejected" ${ticket.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                                    <option value="completed" ${ticket.status === 'completed' ? 'selected' : ''}>Completed</option>
                                </select>
                            </div>
                            
                            <div class="form-group ticket-form-full">
                                <label for="edit-notes-${ticket._id}">
                                    <i class="fas fa-sticky-note"></i> Admin Notes
                                </label>
                                <textarea id="edit-notes-${ticket._id}" rows="4">${ticket.adminNotes || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="cancel-btn" onclick="toggleTicketEdit('${ticket._id}', '${userId}')">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button type="submit" class="save-btn">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </form>
                `;
                
                ticketsList.appendChild(editForm);
            });
        }
        
        // Function to toggle ticket edit mode
        function toggleTicketEdit(ticketId, userId) {
            const form = document.getElementById(`ticket-edit-form-${ticketId}`);
            if (!form) {
                console.error(`Could not find edit form for ticket ${ticketId}`);
                showNotification(`Error: Could not find edit form for this ticket`, 'error');
                return;
            }
            
            if (form.style.display === 'none') {
                // Hide any other open edit forms first
                document.querySelectorAll('.ticket-edit-form').forEach(f => {
                    if (f.id !== `edit-form-${ticketId}`) {
                        f.style.display = 'none';
                    }
                });
                
                // Then show this form
                form.style.display = 'block';
                
                // Add a highlight to the ticket item
                const ticketItem = form.closest('.ticket-item');
                if (ticketItem) {
                    ticketItem.classList.add('editing');
                }
                
                // Scroll to make form visible
                form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                console.log(`Edit form for ticket ${ticketId} opened`);
            } else {
                // Hide the form
                form.style.display = 'none';
                
                // Remove highlight
                const ticketItem = form.closest('.ticket-item');
                if (ticketItem) {
                    ticketItem.classList.remove('editing');
                }
                
                console.log(`Edit form for ticket ${ticketId} closed`);
            }
        }
        
        // Function to handle ticket edit
        async function handleTicketEdit(event, ticketId, userId) {
            event.preventDefault();
            
            const form = event.target;
            const saveButton = form.querySelector('.save-btn');
            const cancelButton = form.querySelector('.cancel-btn');
            
            // Disable buttons and show loading state
            saveButton.disabled = true;
            cancelButton.disabled = true;
            const originalButtonText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            // Set timeout
            const timeout = setTimeout(() => {
                saveButton.disabled = false;
                cancelButton.disabled = false;
                saveButton.innerHTML = originalButtonText;
                showToast('Request is taking longer than expected. Please try again.', 'warning');
            }, 10000);
            
            try {
                const ticketData = {
                    game: document.getElementById(`edit-game-${ticketId}`).value.trim(),
                    sectionType: document.getElementById(`edit-section-type-${ticketId}`).value,
                    section: document.getElementById(`edit-section-${ticketId}`).value.trim(),
                    quantity: parseInt(document.getElementById(`edit-quantity-${ticketId}`).value),
                    basePrice: parseFloat(document.getElementById(`edit-base-price-${ticketId}`).value),
                    totalPrice: parseFloat(document.getElementById(`edit-total-price-${ticketId}`).value),
                    status: document.getElementById(`edit-status-${ticketId}`).value,
                    adminNotes: document.getElementById(`edit-notes-${ticketId}`).value.trim()
                };
                
                const response = await fetch(`/api/admin/tickets/${userId}/${ticketId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(ticketData)
                });
                
                clearTimeout(timeout);
                
                if (!response.ok) {
                    throw new Error(`Failed to update ticket: ${response.status}`);
                }
                
                // Success handling
                showToast('Ticket updated successfully!', 'success');
                toggleTicketEdit(ticketId, userId);
                
                // Refresh the tickets list after a short delay
                setTimeout(() => {
                    fetchUserTickets(userId);
                }, 300);
                
            } catch (error) {
                console.error('Error updating ticket:', error);
                showToast(error.message || 'Failed to update ticket', 'error');
            } finally {
                clearTimeout(timeout);
                saveButton.disabled = false;
                cancelButton.disabled = false;
                saveButton.innerHTML = originalButtonText;
            }
        }
        
        // Function to delete ticket
        async function deleteTicket(ticketId, userId) {
            if (!confirm('Are you sure you want to delete this ticket? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/tickets/${userId}/${ticketId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to delete ticket: ${response.status}`);
                }
                
                showToast('Ticket deleted successfully!', 'success');
                fetchUserTickets(userId);
            } catch (error) {
                console.error('Error deleting ticket:', error);
                showToast(error.message || 'Failed to delete ticket', 'error');
            }
        }
        
        // Function to open ticket modal
        async function openTicketModal(ticketId, userId) {
            try {
                console.log('Opening ticket modal for:', { ticketId, userId });
                
                // Reset any existing state
                const modal = document.getElementById('editTicketModal');
                const form = document.getElementById('ticketEditForm');
                form.reset();
                form.setAttribute('data-user-id', userId);
                
                // Reset button state
                const saveButton = document.getElementById('ticketSaveBtn');
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                
                // Show the modal
                modal.style.display = 'block';
                
                // Show a loading message in the form
                const loadingHtml = '<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading ticket details...</div>';
                document.querySelector('.ticket-form-grid').innerHTML = loadingHtml;
                
                // Fetch ticket data
                console.log('Fetching ticket data from API...');
                const response = await fetch(`/api/admin/tickets/${userId}/${ticketId}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch ticket: ${response.status}`);
                }
                
                const ticket = await response.json();
                console.log('Ticket data received:', ticket);
                
                // Restore the original form structure
                document.querySelector('.ticket-form-grid').innerHTML = `
                    <div class="ticket-form-section">
                        <label for="game">Game</label>
                        <input type="text" id="game" name="game" required>
                    </div>
                    
                    <div class="ticket-form-section">
                        <label for="sectionType">Section Type</label>
                        <select id="sectionType" name="sectionType" required onchange="updateAdminSections()">
                            <option value="">Select section type</option>
                            <option value="Floor">Floor</option>
                            <option value="VIP">VIP</option>
                            <option value="Lower">Lower Level</option>
                            <option value="Mid">Mid Level</option>
                            <option value="Upper">Upper Level</option>
                            <option value="Special">Special Event</option>
                        </select>
                    </div>
                    
                    <div class="ticket-form-section">
                        <label for="section">Section</label>
                        <input type="text" id="section" name="section" required>
                    </div>
                    
                    <div class="ticket-form-section">
                        <label for="quantity">Quantity</label>
                        <input type="number" id="quantity" name="quantity" min="1" max="10" required>
                    </div>
                    
                    <div class="ticket-form-section">
                        <label for="basePrice">Base Price ($)</label>
                        <input type="number" id="basePrice" name="basePrice" min="0" step="0.01" required>
                    </div>
                    
                    <div class="ticket-form-section">
                        <label for="totalPrice">Total Price ($)</label>
                        <input type="number" id="totalPrice" name="totalPrice" min="0" step="0.01" required>
                    </div>
                    
                    <div class="ticket-form-section">
                        <label for="status">Status</label>
                        <select id="status" name="status" required>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    
                    <div class="ticket-form-section">
                        <label for="notes">Admin Notes</label>
                        <textarea id="notes" name="notes" rows="4"></textarea>
                    </div>
                `;
                
                // Set hidden input
                document.getElementById('ticketIdInput').value = ticket._id || '';
                
                // Set form values with a short delay to ensure DOM is ready
                setTimeout(() => {
                    document.getElementById('game').value = ticket.game || '';
                    document.getElementById('sectionType').value = ticket.sectionType || '';
                    document.getElementById('section').value = ticket.section || '';
                    document.getElementById('quantity').value = ticket.quantity || '';
                    document.getElementById('basePrice').value = ticket.basePrice || '';
                    document.getElementById('totalPrice').value = ticket.totalPrice || '';
                    document.getElementById('status').value = ticket.status ? ticket.status.toLowerCase() : 'pending';
                    document.getElementById('notes').value = ticket.adminNotes || '';
                    
                    console.log('Form fields populated:', {
                        game: document.getElementById('game').value,
                        status: document.getElementById('status').value
                    });
                }, 100);
                
                // Double-check that form has the user ID
                if (form.getAttribute('data-user-id') !== userId) {
                    form.setAttribute('data-user-id', userId);
                }
            } catch (error) {
                console.error('Error opening ticket modal:', error);
                showToast(`Failed to load ticket details: ${error.message}`, 'error');
                closeTicketModal();
            }
        }
        
        // Function to close ticket modal
        function closeTicketModal() {
            try {
                const modal = document.getElementById('editTicketModal');
                if (!modal) return;
                
                // Clean up any loaders first
                cleanupAllLoaders();
                
                // Hide the modal
                modal.style.display = 'none';
                
                // Reset form
                const form = document.getElementById('ticketEditForm');
                if (form) {
                    form.reset();
                    // Preserve user ID for future reference
                    const userId = form.getAttribute('data-user-id');
                    if (userId) {
                        localStorage.setItem('lastTicketUserId', userId);
                    }
                }
                
                // Reset button state
                const saveButton = document.getElementById('ticketSaveBtn');
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                }
            } catch (error) {
                console.error('Error closing ticket modal:', error);
                // Force hide the modal even if there's an error
                const modal = document.getElementById('editTicketModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
        }

        // Function to clean up all loaders
        function cleanupAllLoaders() {
            // Hide any loading spinners in buttons
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                if (button.innerHTML.includes('fa-spinner')) {
                    // Try to restore original text if possible
                    if (button.dataset.originalText) {
                        button.innerHTML = button.dataset.originalText;
                    } else if (button.id === 'ticketSaveBtn') {
                        button.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                    }
                    button.disabled = false;
                }
            });
        }
        
        // Function to refresh users
        function refreshUsers() {
            loadUsers();
            showToast('Users refreshed', 'success');
        }
        
        // Check admin status when page loads
        window.addEventListener('DOMContentLoaded', checkAdminStatus);

        // Close edit modal function
        function closeEditModal() {
            try {
                const modal = document.getElementById('edit-modal');
                if (!modal) return;
                
                // Clean up any loaders first
                cleanupAllLoaders();
                
                // Hide the modal
                modal.style.display = 'none';
                
                // Reset form
                const form = document.getElementById('edit-user-form');
                if (form) {
                    form.reset();
                }
                
                // Reset button state
                const saveButton = form?.querySelector('button[type="submit"]');
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = 'Save Changes';
                }
            } catch (error) {
                console.error('Error closing edit modal:', error);
                // Force hide the modal even if there's an error
                const modal = document.getElementById('edit-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
        }

        function showToast(message, type = 'info') {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.position = 'fixed';
                toastContainer.style.bottom = '20px';
                toastContainer.style.right = '20px';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.backgroundColor = type === 'success' ? '#2ecc71' : 
                                        type === 'error' ? '#e74c3c' : 
                                        type === 'warning' ? '#f39c12' : '#3498db';
            toast.style.color = '#fff';
            toast.style.padding = '12px 20px';
            toast.style.borderRadius = '5px';
            toast.style.marginTop = '10px';
            toast.style.boxShadow = '0 3px 10px rgba(0,0,0,0.2)';
            toast.style.display = 'flex';
            toast.style.alignItems = 'center';
            toast.style.justifyContent = 'space-between';
            toast.style.minWidth = '250px';
            toast.style.maxWidth = '400px';
            toast.style.animation = 'fadeIn 0.3s, fadeOut 0.3s 2.7s';
            
            // Add icon based on type
            let icon = '';
            if (type === 'success') icon = '✅';
            else if (type === 'error') icon = '❌';
            else if (type === 'warning') icon = '⚠️';
            else icon = 'ℹ️';
            
            toast.innerHTML = `<span>${icon} ${message}</span>`;
            
            // Add close button
            const closeBtn = document.createElement('button');
            closeBtn.style.background = 'none';
            closeBtn.style.border = 'none';
            closeBtn.style.color = '#fff';
            closeBtn.style.fontSize = '16px';
            closeBtn.style.marginLeft = '10px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.innerHTML = '×';
            closeBtn.onclick = () => toastContainer.removeChild(toast);
            toast.appendChild(closeBtn);
            
            // Add to container
            toastContainer.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toastContainer.contains(toast)) {
                    toastContainer.removeChild(toast);
                }
            }, 3000);
        }

        function openTicketEditModal(ticketId) {
            const modal = document.getElementById('ticket-edit-modal');
            const form = document.getElementById('ticket-edit-form');
            
            // Reset form and show loading state
            form.reset();
            form.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading ticket data...</div>';
            modal.style.display = 'block';
            
            // Fetch ticket data
            fetch(`/api/admin/tickets/${ticketId}`, {
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to fetch ticket data');
                return response.json();
            })
            .then(ticket => {
                // Restore form structure with ticket data
                form.innerHTML = `
                    <input type="hidden" id="edit-ticket-id" value="${ticket._id}">
                    
                    <div class="form-group">
                        <label for="edit-ticket-section">
                            <i class="fas fa-map-marker-alt"></i> Section
                        </label>
                        <input type="text" id="edit-ticket-section" value="${ticket.section}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-ticket-type">
                            <i class="fas fa-ticket-alt"></i> Type
                        </label>
                        <select id="edit-ticket-type" required>
                            <option value="Regular" ${ticket.type === 'Regular' ? 'selected' : ''}>Regular</option>
                            <option value="VIP" ${ticket.type === 'VIP' ? 'selected' : ''}>VIP</option>
                            <option value="Courtside" ${ticket.type === 'Courtside' ? 'selected' : ''}>Courtside</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-ticket-quantity">
                            <i class="fas fa-hashtag"></i> Quantity
                        </label>
                        <input type="number" id="edit-ticket-quantity" value="${ticket.quantity}" min="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-ticket-price">
                            <i class="fas fa-dollar-sign"></i> Price
                        </label>
                        <input type="number" id="edit-ticket-price" value="${ticket.price}" min="0" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-ticket-date">
                            <i class="fas fa-calendar"></i> Date
                        </label>
                        <input type="date" id="edit-ticket-date" value="${ticket.date.split('T')[0]}" required>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="cancel-btn" onclick="closeTicketEditModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="save-btn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error fetching ticket:', error);
                showToast('Failed to load ticket data', 'error');
                closeTicketEditModal();
            });
        }

        function closeTicketEditModal() {
            const modal = document.getElementById('ticket-edit-modal');
            if (!modal) return;
            
            modal.style.display = 'none';
            
            // Reset form
            const form = document.getElementById('ticket-edit-form');
            if (form) form.reset();
            
            // Enable all buttons
            const buttons = modal.querySelectorAll('button');
            buttons.forEach(button => {
                button.disabled = false;
                if (button.classList.contains('save-btn')) {
                    button.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                }
            });
        }

        function displayTickets(tickets) {
            const ticketsContainer = document.querySelector('.tickets-list');
            ticketsContainer.innerHTML = '';

            if (!tickets || tickets.length === 0) {
                ticketsContainer.innerHTML = '<div class="no-tickets">No tickets found</div>';
                return;
            }

            tickets.forEach(ticket => {
                const ticketItem = document.createElement('div');
                ticketItem.className = 'ticket-item';
                ticketItem.dataset.ticketId = ticket._id;

                // Main ticket info
                ticketItem.innerHTML = `
                    <div class="ticket-game">${ticket.game}</div>
                    <div class="ticket-details">
                        <span class="ticket-section">${ticket.sectionType} - ${ticket.section}</span>
                        <span class="ticket-quantity">${ticket.quantity} tickets</span>
                        <span class="ticket-price">$${ticket.basePrice} per ticket</span>
                        <span class="ticket-total">Total: $${ticket.totalPrice}</span>
                    </div>
                    <div class="ticket-status ticket-status-${ticket.status.toLowerCase()}">${ticket.status}</div>
                    <div class="ticket-actions">
                        <button onclick="toggleTicketEdit('${ticket._id}')" class="edit-btn" aria-label="Edit ticket" title="Edit ticket">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTicket('${ticket._id}')" class="delete-btn" aria-label="Delete ticket" title="Delete ticket">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;

                // Create edit form (initially hidden)
                const editForm = document.createElement('form');
                editForm.className = 'ticket-edit-form';
                editForm.id = `ticket-edit-form-${ticket._id}`;
                editForm.style.display = 'none';
                
                // Set up form fields
                editForm.innerHTML = `
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="game-${ticket._id}">
                                <i class="fas fa-basketball-ball"></i> Game
                            </label>
                            <input type="text" id="game-${ticket._id}" name="game" value="${ticket.game}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="sectionType-${ticket._id}">
                                <i class="fas fa-layer-group"></i> Section Type
                            </label>
                            <select id="sectionType-${ticket._id}" name="sectionType" required onchange="updateEditPrice('${ticket._id}')">
                                <option value="Floor" ${ticket.sectionType === 'Floor' ? 'selected' : ''}>Floor</option>
                                <option value="VIP" ${ticket.sectionType === 'VIP' ? 'selected' : ''}>VIP</option>
                                <option value="Lower" ${ticket.sectionType === 'Lower' ? 'selected' : ''}>Lower Level</option>
                                <option value="Mid" ${ticket.sectionType === 'Mid' ? 'selected' : ''}>Mid Level</option>
                                <option value="Upper" ${ticket.sectionType === 'Upper' ? 'selected' : ''}>Upper Level</option>
                                <option value="Special" ${ticket.sectionType === 'Special' ? 'selected' : ''}>Special Event</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="section-${ticket._id}">
                                <i class="fas fa-map-marker-alt"></i> Section
                            </label>
                            <input type="text" id="section-${ticket._id}" name="section" value="${ticket.section}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="quantity-${ticket._id}">
                                <i class="fas fa-ticket-alt"></i> Quantity
                            </label>
                            <input type="number" id="quantity-${ticket._id}" name="quantity" value="${ticket.quantity}" min="1" max="10" required onchange="updateEditPrice('${ticket._id}')">
                        </div>
                        
                        <div class="form-group">
                            <label for="status-${ticket._id}">
                                <i class="fas fa-flag"></i> Status
                            </label>
                            <select id="status-${ticket._id}" name="status" required>
                                <option value="Pending" ${ticket.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Approved" ${ticket.status === 'Approved' ? 'selected' : ''}>Approved</option>
                                <option value="Rejected" ${ticket.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                                <option value="Completed" ${ticket.status === 'Completed' ? 'selected' : ''}>Completed</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="adminNotes-${ticket._id}">
                                <i class="fas fa-sticky-note"></i> Admin Notes
                            </label>
                            <textarea id="adminNotes-${ticket._id}" name="adminNotes">${ticket.adminNotes || ''}</textarea>
                        </div>
                    </div>
                    
                    <div class="price-info">
                        <p>Base Price: $<span id="basePrice-${ticket._id}">${ticket.basePrice}</span></p>
                        <p>Total Price: $<span id="totalPrice-${ticket._id}">${ticket.totalPrice}</span></p>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="save-btn" aria-label="Save changes" title="Save changes">
                            <i class="fas fa-save"></i> Save
                        </button>
                        <button type="button" class="cancel-btn" aria-label="Cancel editing" title="Cancel editing" onclick="toggleTicketEdit('${ticket._id}')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                `;
                
                // Add the form to the ticket item
                ticketItem.appendChild(editForm);
                
                // Add the ticket item to the container
                ticketsContainer.appendChild(ticketItem);
                
                // Add form submission event listener
                editForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    handleTicketEdit(event, ticket._id);
                });
            });
        }
        
        // Function to toggle ticket edit mode
        function toggleTicketEdit(ticketId) {
            const form = document.getElementById(`ticket-edit-form-${ticketId}`);
            if (!form) {
                console.error(`Could not find edit form for ticket ${ticketId}`);
                showNotification('Error: Could not find edit form for this ticket', 'error');
                return;
            }
            
            // Hide any other open edit forms first
            document.querySelectorAll('.ticket-edit-form').forEach(f => {
                if (f.id !== `ticket-edit-form-${ticketId}` && f.style.display !== 'none') {
                    f.style.display = 'none';
                    const ticketItem = f.closest('.ticket-item');
                    if (ticketItem) ticketItem.classList.remove('editing');
                }
            });
            
            // Toggle this form
            if (form.style.display === 'none') {
                form.style.display = 'block';
                
                // Add a highlight to the ticket item
                const ticketItem = form.closest('.ticket-item');
                if (ticketItem) {
                    ticketItem.classList.add('editing');
                }
                
                // Scroll to make form visible
                form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                console.log(`Edit form for ticket ${ticketId} opened`);
            } else {
                // Hide the form
                form.style.display = 'none';
                
                // Remove highlight
                const ticketItem = form.closest('.ticket-item');
                if (ticketItem) {
                    ticketItem.classList.remove('editing');
                }
                
                console.log(`Edit form for ticket ${ticketId} closed`);
            }
        }
        
        // Function to handle ticket edit form submission
        async function handleTicketEdit(event, ticketId) {
            event.preventDefault();
            console.log(`Handling ticket edit submission for ticket ID: ${ticketId}`);
            
            const form = document.getElementById(`ticket-edit-form-${ticketId}`);
            if (!form) {
                console.error(`Edit form not found for ticket ID: ${ticketId}`);
                showNotification('Error: Form not found', 'error');
                return;
            }
            
            const saveBtn = form.querySelector('.save-btn');
            const cancelBtn = form.querySelector('.cancel-btn');
            
            // Disable buttons and show loading state
            saveBtn.disabled = true;
            cancelBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            try {
                const formData = {
                    game: document.getElementById(`game-${ticketId}`).value,
                    sectionType: document.getElementById(`sectionType-${ticketId}`).value,
                    section: document.getElementById(`section-${ticketId}`).value,
                    quantity: parseInt(document.getElementById(`quantity-${ticketId}`).value),
                    status: document.getElementById(`status-${ticketId}`).value,
                    adminNotes: document.getElementById(`adminNotes-${ticketId}`).value || ''
                };
                
                console.log('Submitting ticket update with data:', formData);
                
                const response = await fetch(`/api/tickets/${ticketId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // Important for session cookies
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Error ${response.status}: Failed to update ticket`);
                }
                
                const data = await response.json();
                console.log('Ticket update successful:', data);
                
                showNotification('Ticket updated successfully', 'success');
                
                // Close the edit form
                toggleTicketEdit(ticketId);
                
                // Refresh the tickets list after a short delay
                setTimeout(() => {
                    loadTickets();
                }, 300);
            } catch (error) {
                console.error('Error updating ticket:', error);
                showNotification(error.message || 'Failed to update ticket', 'error');
            } finally {
                if (saveBtn && !saveBtn.isConnected) {
                    console.log('Button no longer in DOM, skipping state reset');
                } else {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
                }
                
                if (cancelBtn && !cancelBtn.isConnected) {
                    console.log('Cancel button no longer in DOM, skipping state reset');
                } else {
                    cancelBtn.disabled = false;
                }
            }
        }
        
        // Function to update price for ticket editing
        function updateEditPrice(ticketId) {
            const sectionType = document.getElementById(`sectionType-${ticketId}`).value;
            const quantity = parseInt(document.getElementById(`quantity-${ticketId}`).value) || 0;
            
            if (!sectionType || !quantity) return;
            
            let basePrice;
            switch(sectionType) {
                case 'Floor':
                    basePrice = 500;
                    break;
                case 'VIP':
                    basePrice = 300;
                    break;
                case 'Lower':
                    basePrice = 200;
                    break;
                case 'Mid':
                    basePrice = 150;
                    break;
                case 'Upper':
                    basePrice = 100;
                    break;
                case 'Special':
                    basePrice = 250;
                    break;
                default:
                    basePrice = 100;
            }
            
            let quantityMultiplier = 1;
            if (quantity >= 5) {
                quantityMultiplier = 0.9; // 10% discount
            } else if (quantity >= 3) {
                quantityMultiplier = 0.95; // 5% discount
            }
            
            const totalPrice = (basePrice * quantity * quantityMultiplier).toFixed(2);
            
            // Update displayed values
            const basePriceEl = document.getElementById(`basePrice-${ticketId}`);
            const totalPriceEl = document.getElementById(`totalPrice-${ticketId}`);
            
            if (basePriceEl) basePriceEl.textContent = basePrice;
            if (totalPriceEl) totalPriceEl.textContent = totalPrice;
        }

        // Add deleteTicket function
        async function deleteTicket(ticketId) {
            if (!confirm("Are you sure you want to delete this ticket? This action cannot be undone.")) {
                return;
            }
            
            try {
                const response = await fetch(`/api/tickets/${ticketId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete ticket');
                }
                
                showNotification('Ticket deleted successfully!', 'success');
                
                // Remove the ticket from DOM
                const ticketItem = document.querySelector(`.ticket-item[data-ticket-id="${ticketId}"]`);
                if (ticketItem) {
                    ticketItem.remove();
                } else {
                    // If we can't find the element, reload all tickets
                    await loadTickets();
                }
            } catch (error) {
                console.error('Error deleting ticket:', error);
                showNotification(error.message, 'error');
            }
        }

        // Function to load all tickets
        async function loadTickets() {
            try {
                const response = await fetch('/api/admin/tickets', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch tickets');
                }
                
                const tickets = await response.json();
                displayTickets(tickets);
                
            } catch (error) {
                console.error('Error loading tickets:', error);
                showNotification('Failed to load tickets. Please try again.', 'error');
            }
        }

        // Load tickets when clicking on the Tickets tab
        document.addEventListener('DOMContentLoaded', function() {
            const ticketsTab = document.querySelector('.tab-btn[data-tab="tickets"]');
            if (ticketsTab) {
                ticketsTab.addEventListener('click', function() {
                    loadTickets();
                });
            }
        });
    </script>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <img src="images/backgrounds/logo2.svg" alt="Celtics Logo" class="footer-logo">
                <p class="footer-description">The most successful team in NBA history, with 18 championships and counting.</p>
                <div class="social-links">
                    <a href="https://www.facebook.com/bostonceltics/" target="_blank" rel="noopener noreferrer">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://www.instagram.com/celtics/?hl=en" target="_blank" rel="noopener noreferrer">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="https://x.com/celtics" target="_blank" rel="noopener noreferrer">
                        <i class="fa-solid fa-x"></i>
                    </a>
                </div>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <ul class="footer-links">
                    <li><a href="MYweb.html">Home</a></li>
                    <li><a href="MYweb.html#news">News</a></li>
                    <li><a href="schedule.html">Schedule</a></li>
                    <li><a href="roster.html">Roster</a></li>
                    <li><a href="getTickets.html">Tickets</a></li>
                </ul>
            </div>
            <div class="footer-section" id="footer-contact">
                <h4>Contact Us</h4>
                <ul class="contact-info">
                    <li>
                        <i class="fas fa-user"></i>
                        <span>Yoav Cohen</span>
                    </li>
                    <li>
                        <i class="fas fa-envelope"></i>
                        <span>yoav23cohen@gmail.com</span>
                    </li>
                    <li>
                        <i class="fas fa-phone"></i>
                        <span>+972 52-466-9882</span>
                    </li>
                    <li>
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Herut, Israel</span>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/yoav-cohen-42b4272a5/" target="_blank" rel="noopener noreferrer">
                            <i class="fab fa-linkedin"></i>
                            <span>LinkedIn Profile</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Newsletter</h4>
                <p>Subscribe to get the latest Celtics news and updates.</p>
                <div class="newsletter-form">
                    <input type="email" placeholder="Enter your email" aria-label="Email for newsletter">
                    <button type="submit" aria-label="Subscribe to newsletter">Subscribe</button>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="footer-bottom-content">
                <p>&copy; 2024 Boston Celtics. All rights reserved.</p>
                <div class="footer-legal">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Cookie Policy</a>
                </div>
            </div>
        </div>
    </footer>
</body>
</html> 